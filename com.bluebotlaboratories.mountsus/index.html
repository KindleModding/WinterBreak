<!DOCTYPE HTML>

<!-- Copyright Bluebotlaboratories -->

<html>
<head>
  <meta name="viewport" content="user-scalable=no"/>
  <script src="file:///mnt/us/mesquito/polyfill.min.js"></script>
  <script src="file:///mnt/us/mesquito/sdk.js"></script>
  <script src="./main.js"></script>
  <script src="./inspect.js"></script>

  <link href="./main.css" rel="stylesheet">

  <title>MountSus</title>
  
  <script>
    var kindle = window.kindle || top.kindle;
  </script>
</head>
<body>
  <h1>MountSus</h1>
  <p>v0.0.27a</p>
  <textarea rows=10 id="log"></textarea>
  
  <button onclick="testBridge()">JAILBREAK!</button>

  <button onclick="testJB()">Verify Exploit</button>

  <script>
    log("Ready to Jailbreak!");

    function writeFile(fileData, filePath) {
      log("Activating dialog");
      kindle.messaging.sendMessage("com.lab126.pillow", "customDialog", { name: "../../../../../../mnt/us/apps/com.bluebotlaboratories.mountsus/dialoger", clientParams:{show:true, jsEnabled:false, fileData:fileData, filePath:filePath} });
      log("Dialog activated");
    }

    function testBridge() {
      // Read file contents
      log("Locating mntus.params file...");
      fetchFile("/var/local/root/mntus.params").then(function (fileContents) {
        if (fileContents.includes("# auto-generated file -- do not modify!")) {
          log("mntus.params file found...");
          writeFile("sh /mnt/us/jb.sh\n" + fileContents, "/var/local/root/mntus.params")
        } else {
          fetchFile("/var/local/system/mntus.params").then(function (fileContents) {
            if (fileContents.includes("# auto-generated file -- do not modify!")) {
              log("mntus.params file found in alternate location...");
              writeFile("sh /mnt/us/jb.sh\n" + fileContents, "/var/local/system/mntus.params")
            } else {
              log("ERROR - Could not locate mntus.params file - Please file a GitHub issue")
            }
          });
        }
      });
    }

    function testJB() {
      // Read file contents
      log("Locating mntus.params file...");
      fetchFile("/var/local/root/mntus.params").then(function (fileContents) {
        if (fileContents.includes("source /mnt/us/jb.sh")) {
          log("Exploit verified!");
        } else {
          fetchFile("/var/local/system/mntus.params").then(function (fileContents) {
            if (fileContents.includes("source /mnt/us/jb.sh")) {
              log("Exploit verified!");
            } else {
              log("ERROR - Exploit could not be verified!");
            }
          });
        }
      });
    }
  </script>

  <div id="lastCommands"></div>
</body>
</html>