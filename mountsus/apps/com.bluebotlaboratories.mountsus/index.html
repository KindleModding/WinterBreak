<!DOCTYPE HTML>

<!-- Copyright Bluebotlaboratories -->

<html>
<head>
  <meta name="viewport" content="user-scalable=no"/>
  <script src="file:///mnt/us/mesquito/polyfill.min.js"></script>
  <script src="file:///mnt/us/mesquito/sdk.js"></script>
  <script src="./main.js"></script>
  <script src="./inspect.js"></script>

  <link href="./main.css" rel="stylesheet">

  <title>MountSus</title>
  
  <script>
    var kindle = window.kindle || top.kindle;
  </script>
</head>
<body>
  <h1>MountSus</h1>
  <p>v0.0.27a</p>
  <textarea rows=10 id="log"></textarea>
  
  <button id="jailbreakButton" onclick="jailbreak()">JAILBREAK!</button>
  <button id="verifyButton" style="display: none;" onclick="verifyExploit()">Verify Exploit</button>

  <script>
    var version = kindle.device.getSoftwareVersionString();
    log("Checking version...");
    log(version)
    version = version.split('.');
    if (Number(version[0]) < 5 || Number(version[0]) < 16 || Number(version[0]) < 3) {
      log("This firmware is NOT supported by MountSus! Please update to at least v5.16.3");
      log("This firmware version is available from Amazon and from Kindle Modding Wiki.");
      document.getElementById("jailbreakButton").style = "display: none;";
      document.getElementById("verifyButton").style = "display: none;";
    }

    log("Ready to Jailbreak!");

    function writeFile(fileData, filePath) {
      log("Activating dialog");
      kindle.messaging.sendMessage("com.lab126.pillow", "customDialog", { name: "../../../../../../mnt/us/apps/com.bluebotlaboratories.mountsus/dialoger", clientParams:{show:true, jsEnabled:false, fileData:fileData, filePath:filePath} });
      log("Dialog activated");
    }

    function jailbreak() {
      document.getElementById("verifyButton").style = "display: block;";
      // Read file contents
      log("Locating mntus.params file...");
      fetchFile("/var/local/root/mntus.params").then(function (fileContents) {
        if (fileContents.includes("# auto-generated file -- do not modify!")) {
          log("mntus.params file found...");
          writeFile("sh /mnt/us/jb.sh\n" + fileContents, "/var/local/root/mntus.params")
        } else {
          fetchFile("/var/local/system/mntus.params").then(function (fileContents) {
            if (fileContents.includes("# auto-generated file -- do not modify!")) {
              log("mntus.params file found in alternate location...");
              writeFile("sh /mnt/us/jb.sh\n" + fileContents, "/var/local/system/mntus.params")
            } else {
              log("ERROR - Could not locate mntus.params file - Please file a GitHub issue")
            }
          });
        }
      });
    }

    function testFile() {
      // Read file contents
      log("Locating mntus.params file...");
      fetchFile("/var/local/root/mntus.params").then(function (fileContents) {
        if (fileContents.includes("sh /mnt/us/jb.sh")) {
          log("Exploit verified! Please REBOOT!");
        } else {
          fetchFile("/var/local/system/mntus.params").then(function (fileContents) {
            if (fileContents.includes("source /mnt/us/jb.sh")) {
              log("Exploit verified! Please Reboot");
            } else {
              log("ERROR - Exploit could not be verified!");
            }
          });
        }
      });
    }

    function verifyExploit() {
      document.getElementById("verifyButton").style = "display: none;";
      setInterval(testFile, 500);
    }
  </script>
</body>
</html>